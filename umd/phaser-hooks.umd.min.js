!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lodash.merge")):"function"==typeof define&&define.amd?define(["exports","lodash.merge"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).phaserHooks={},e._.merge)}(this,function(e,t){"use strict";var n={numberRange:function(e,t){return function(n){var o=n;return"number"!=typeof o||Number.isNaN(o)?"Value must be a number":!(o<e||o>t)||"Value must be between ".concat(e," and ").concat(t)}},nonEmptyString:function(e){return"string"==typeof e&&0!==e.trim().length||"Value must be a non-empty string"},arrayLength:function(e,t){return function(n){var o=n;return Array.isArray(o)?o.length<e?"Array must have at least ".concat(e," items"):!(void 0!==t&&o.length>t)||"Array must have at most ".concat(t," items"):"Value must be an array"}},oneOf:function(e){return function(t){return!!e.includes(t)||"Value must be one of: ".concat(e.join(", "))}}},o=function(){return o=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)};function r(e,t,n){if(n||2===arguments.length)for(var o,r=0,a=t.length;r<a;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var a=function(){return(new Date).toISOString().replace("T"," ").replace("Z","")},c=function(e){var t=a(),n=e?" %c".concat(e,"%c"):"";return"%c[".concat(t,"]%c ").concat("%c[phaser-hooks]%c").concat(n)},i=function(e){var t=["color: #bd93f9; font-weight: bold;","color: inherit;","color: #2563eb; font-weight: bold;","color: inherit;"];return e&&t.push("color: #059669; font-weight: bold;","color: inherit;"),t},l=function(e,t,n){var o=c("STATE_SET"),l=i("STATE_SET");console.groupCollapsed.apply(console,r(["".concat(o,' Updating state "').concat(e,'"')],l,!1)),console.log("🔑 Key:",e),console.log("📤 Old Value:",t),console.log("📥 New Value:",n),console.log("🔄 Changed:",t!==n),console.log("⏰ Timestamp:",a()),console.groupEnd()},s=function(e,t,n){var o=c("EVENT_ADD"),l=i("EVENT_ADD");console.groupCollapsed.apply(console,r(["".concat(o,' Adding listener for "').concat(e,'"')],l,!1)),console.log("🔑 Key:",e),console.log("📡 Event:",t),console.log("🎯 Callback:",n.name||"anonymous"),console.log("⏰ Timestamp:",a()),console.groupEnd()},u=function(e,t,n){var o=c("EVENT_REMOVE"),l=i("EVENT_REMOVE");console.groupCollapsed.apply(console,r(["".concat(o,' Removing listener for "').concat(e,'"')],l,!1)),console.log("🔑 Key:",e),console.log("📡 Event:",t),console.log("🎯 Callback:",n.name||"anonymous"),console.log("⏰ Timestamp:",a()),console.groupEnd()},f=function(e,t,n){var o=e.get(t);return n&&function(e,t){var n=c("STATE_GET"),o=i("STATE_GET");console.log.apply(console,r(r(["".concat(n,' Getting state "').concat(e,'":')],o,!1),[t],!1))}(t,o),o},g=function(e,t,n,o){var s,u,f,g,p;if(u="onChange callback is deprecated in phaser-hooks. Use .on('change', callback) or .once('change', callback) instead.",f={key:t},g=c(s="DEPRECATED_ONCHANGE"),p=i(s),console.groupCollapsed.apply(console,r(["".concat(g," WARNING")],p,!1)),console.warn("⚠️ Operation:",s),console.warn("📢 Message:",u),f&&console.warn("📋 Context:",f),console.warn("⏰ Timestamp:",a()),console.groupEnd(),!o||"function"!=typeof o)throw new Error("[withStateDef] onChange callback must be a function");e.events.on("changedata-".concat(t),function(e,t,s,u){n&&l(t,u,s);try{o(s,u)}catch(e){!function(e,t,n){var o=c(e),l=i(e);console.groupCollapsed.apply(console,r(["".concat(o," ERROR")],l,!1)),console.error("🚨 Operation:",e),console.error("💥 Error:",t),n&&console.error("📋 Context:",n),console.error("⏰ Timestamp:",a()),console.groupEnd()}("ONCHANGE_CALLBACK_ERROR",e,{key:t})}})},p=function(e,t,n,o,l){if(!e.has(t)&&void 0!==l){if(o){var s=o(l);if(!0!==s){var u="string"==typeof s?s:'Invalid initial value for key "'.concat(t,'"');throw new Error("[withStateDef] ".concat(u))}}e.set(t,l),n&&function(e,t){var n=c("STATE_INIT"),o=i("STATE_INIT");console.groupCollapsed.apply(console,r(["".concat(n,' Initializing state "').concat(e,'"')],o,!1)),console.log("🔧 Key:",e),console.log("📦 Initial Value:",t),console.log("⏰ Timestamp:",a()),console.groupEnd()}(t,l)}},h=function(e,t,n){e.events.removeAllListeners("changedata-".concat(t)),n&&function(e){var t=c("CLEAR_LISTENERS"),n=i("CLEAR_LISTENERS");console.groupCollapsed.apply(console,r(["".concat(t,' Clearing all listeners for "').concat(e,'"')],n,!1)),console.log("🔑 Key:",e),console.log("🧹 Action:","Removing all event listeners"),console.log("⏰ Timestamp:",a()),console.groupEnd()}(t)},d=function(e,n,o,r){void 0===r&&(r={}),function(e,t,n){if(!e)throw new Error("[withStateDef] Scene parameter is required");if(!n||"string"!=typeof n||0===n.trim().length)throw new Error("[withStateDef] Key must be a non-empty string");if(t.global&&!e.registry)throw new Error("[withStateDef] Scene registry is not available. Ensure the scene is properly initialized.");if(!t.global&&!e.data)throw new Error("[withStateDef] Scene data is not available. Ensure the scene is properly initialized.")}(e,r,n);var a=r.validator,c=r.debug,i=void 0!==c&&c,d=r.global,v=void 0!==d&&d?e.registry:e.data;return p(v,n,i,a,o),{get:function(){return f(v,n,i)},set:function(e){return function(e,t,n,o,r){var a=e.get(t),c="function"==typeof n?n(a):n;if(r){var i=r(c);if(!0!==i){var s="string"==typeof i?i:'Invalid value for key "'.concat(t,'"');throw new Error("[withStateDef] ".concat(s))}}e.set(t,c),o&&l(t,a,c)}(v,n,e,i,a)},patch:function(e){return function(e,n,o,r,a){var c=e.get(n);if("object"!=typeof c||null===c)throw new Error("[withStateDef] Current value is not an object");var i="function"==typeof o?o(c):o,s=t({},c,i);if(a){var u=a(s);if(!0!==u){var f="string"==typeof u?u:'Invalid value for key "'.concat(n,'"');throw new Error("[withStateDef] ".concat(f))}}e.set(n,s),r&&l(n,c,s)}(v,n,e,i,a)},onChange:function(e){return g(v,n,i,e)},on:function(e,t){return function(e,t,n,o,r){if("change"!==t)throw new Error('[withStateDef] Invalid event. Only "change" is supported.');return o&&s(n,t,r),e.events.on("changedata-".concat(n),r),function(){o&&u(n,t,r),e.events.off("changedata-".concat(n),r)}}(v,e,n,i,t)},once:function(e,t){return function(e,t,n,o,r){if("change"!==t)throw new Error('[withStateDef] Invalid event. Only "change" is supported.');return o&&s(n,t,r),e.events.once("changedata-".concat(n),r),function(){o&&u(n,t,r),e.events.off("changedata-".concat(n),r)}}(v,e,n,i,t)},off:function(e,t){return function(e,t,n,o,r){if("change"!==t)throw new Error('[withStateDef] Invalid event. Only "change" is supported.');e.events.off("changedata-".concat(n),r),o&&u(n,t,r)}(v,e,n,i,t)},clearListeners:function(){return h(v,n,i)}}},v=function(e,t,n,r){var a;if(!e)throw new Error("[withLocalState] Scene parameter is required");var c=(null===(a=e.scene)||void 0===a?void 0:a.key)||"unknown-scene",i="phaser-hooks:local:".concat(c,":").concat(t);return d(e,i,n,o(o({},r),{persistent:!1,global:!1}))},y=function(e,t,n,r){if(!e)throw new Error("[withGlobalState] Scene parameter is required");var a="phaser-hooks:global:".concat(t);return d(e,a,n,o(o({},r),{persistent:!1,global:!0}))};e.batchStateUpdates=function(e){e()},e.isValidScene=function(e){return null!=e&&"object"==typeof e&&"registry"in e&&"scene"in e},e.validators=n,e.withComputedState=function(e,t,n,r){var a=r(n.get()),c=v(e,t,a);return n.on("change",function(){var e=n.get(),t=r(e);c.set(t)}),o(o({},c),{set:function(){throw new Error('[withComputedState] Cannot directly set computed state "'.concat(t,'". Update the source state instead.'))}})},e.withDebouncedState=function(e,n,r,a){var c=v(e,n,r),i=null,l=function(e){var t="function"==typeof e?e(c.get()):e;i&&clearTimeout(i),i=setTimeout(function(){c.set(t),i=null},a)};return o(o({},c),{set:l,patch:function(e){var n="function"==typeof e?e(c.get()):e;l(function(e){return t({},e,n)})}})},e.withGlobalState=y,e.withLocalState=v,e.withPersistentState=function(e,t,n,o,r){void 0===r&&(r="local");var a=null!=o?o:"phaser-hooks-state:".concat(t),c=n;try{var i="local"===r?localStorage.getItem(a):sessionStorage.getItem(a);i&&(c=JSON.parse(i))}catch(e){console.warn('[withPersistentState] Failed to load stored state for "'.concat(t,'":'),e)}var l=y(e,t,c);return l.onChange(function(e){try{("local"===r?localStorage:sessionStorage).setItem(a,JSON.stringify(e))}catch(e){console.warn('[withPersistentState] Failed to save state for "'.concat(t,'":'),e)}}),l},e.withStateDef=d,e.withUndoableState=function(e,n,r,a){var c=v(e,n,r),i=v(e,"".concat(n,":history"),[r]),l=v(e,"".concat(n,":historyIndex"),0),s=function(e){var t="function"==typeof e?e(c.get()):e;!function(e){var t=i.get(),n=l.get(),o=t.slice(0,n+1);o.push(e),o.length>a?o.shift():l.set(n+1),i.set(o)}(t),c.set(t)};return o(o({},c),{set:function(e){var t="function"==typeof e?e(c.get()):e;s(t)},patch:function(e){var n="function"==typeof e?e(c.get()):e;s(function(e){return t({},e,n)})},undo:function(){var e=l.get();if(e>0){var t=e-1;l.set(t);var n=i.get()[t];if(void 0!==n)return c.set(n),!0}return!1},redo:function(){var e=l.get(),t=i.get();if(e<t.length-1){var n=e+1;l.set(n);var o=t[n];if(void 0!==o)return c.set(o),!0}return!1},canUndo:function(){return l.get()>0},canRedo:function(){return l.get()<i.get().length-1},clearHistory:function(){var e=c.get();i.set([e]),l.set(0)}})}});
