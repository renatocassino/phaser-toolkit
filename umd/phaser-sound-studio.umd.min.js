!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("phaser"),require("lodash.merge")):"function"==typeof define&&define.amd?define(["exports","phaser","lodash.merge"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).phaserSoundStudio={},e.Phaser,e._.merge)}(this,function(e,o,n){"use strict";var t=function(){function e(e){this.plugin=e,this.plugin=e}return Object.defineProperty(e.prototype,"game",{get:function(){return this.plugin.getGame()},enumerable:!1,configurable:!0}),e.prototype.loadBySoundKey=function(e,o){var n,t=this.game,r=this.plugin;t.cache.audio.has(o)||e.load.audio(o,null===(n=r.soundList[o])||void 0===n?void 0:n.path)},e.prototype.loadByChannel=function(e,o){var n=this,t=this.plugin;Object.entries(t.soundList).filter(function(e){return e[1].channel===o}).forEach(function(o){var t=o[0];n.loadBySoundKey(e,t)})},e}(),r=function(){function e(e){this.plugin=e,this.plugin=e}return Object.defineProperty(e.prototype,"game",{get:function(){return this.plugin.getGame()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"soundRegistry",{get:function(){return this.plugin.soundRegistry},enumerable:!1,configurable:!0}),e.prototype.play=function(e){var o=this.soundRegistry.getChannelBySoundKey(e);switch(o.mode){case"single":this.playSingleMode(e);break;case"multiple":this.playMultipleMode(e,o.maxInstances)}},e.prototype.playSingleMode=function(e){var o,n=this.soundRegistry.getSoundBySoundKey(e);if(n)n.isPlaying||n.play();else{var t=this.soundRegistry.getSoundConfigBySoundKey(e);this.game.sound.add(e,{volume:(null==t?void 0:t.channel)?this.plugin.getChannelVolume(t.channel):1,loop:null!==(o=null==t?void 0:t.loop)&&void 0!==o&&o}).play()}},e.prototype.playMultipleMode=function(e,o){var n;void 0===o&&(o=10);var t=this.soundRegistry.fetchSoundsBySoundKey(e),r=t.find(function(e){return!e.isPlaying});if(r)r.play();else if(t.length<o){var l=this.soundRegistry.getSoundConfigBySoundKey(e);this.game.sound.add(e,{volume:(null==l?void 0:l.channel)?this.plugin.getChannelVolume(l.channel):1,loop:null!==(n=null==l?void 0:l.loop)&&void 0!==n&&n}).play()}},e}(),l=function(){function e(e){this.plugin=e,this.plugin=e}return Object.defineProperty(e.prototype,"game",{get:function(){return this.plugin.getGame()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"soundPlayer",{get:function(){return this.plugin.soundPlayer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"channels",{get:function(){return this.plugin.channels},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"soundList",{get:function(){return this.plugin.soundList},enumerable:!1,configurable:!0}),e.prototype.getSoundConfigBySoundKey=function(e){var o;return null!==(o=this.soundList[e])&&void 0!==o?o:null},e.prototype.getSoundBySoundKey=function(e){var o=this.fetchSoundsBySoundKey(e);return o.length>0?o[0]:null},e.prototype.fetchSoundsBySoundKey=function(e){return this.game.sound.getAll(e)},e.prototype.getChannelBySoundKey=function(e){var o=this.soundList[e];return this.channels[o.channel]},e}(),i=function(e,o){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,o){e.__proto__=o}||function(e,o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])},i(e,o)};"function"==typeof SuppressedError&&SuppressedError;const s=()=>(new Date).toISOString().replace("T"," ").replace("Z",""),a=e=>`%c[${s()}]%c %c[phaser-hooks]%c${e?` %c${e}%c`:""}`,u=e=>{const o=["color: #bd93f9; font-weight: bold;","color: inherit;","color: #2563eb; font-weight: bold;","color: inherit;"];return e&&o.push("color: #059669; font-weight: bold;","color: inherit;"),o},c=(e,o,n)=>{const t=a("STATE_SET"),r=u("STATE_SET");console.groupCollapsed(`${t} Updating state "${e}"`,...r),console.log("🔑 Key:",e),console.log("📤 Old Value:",o),console.log("📥 New Value:",n),console.log("🔄 Changed:",o!==n),console.log("⏰ Timestamp:",s()),console.groupEnd()},h=(e,o,n)=>{const t=a("EVENT_ADD"),r=u("EVENT_ADD");console.groupCollapsed(`${t} Adding listener for "${e}"`,...r),console.log("🔑 Key:",e),console.log("📡 Event:",o),console.log("🎯 Callback:",n.name||"anonymous"),console.log("⏰ Timestamp:",s()),console.groupEnd()},p=(e,o,n)=>{const t=a("EVENT_REMOVE"),r=u("EVENT_REMOVE");console.groupCollapsed(`${t} Removing listener for "${e}"`,...r),console.log("🔑 Key:",e),console.log("📡 Event:",o),console.log("🎯 Callback:",n.name||"anonymous"),console.log("⏰ Timestamp:",s()),console.groupEnd()},d=(e,o,n)=>{const t=e.get(o);return n&&((e,o)=>{const n=a("STATE_GET"),t=u("STATE_GET");console.log(`${n} Getting state "${e}":`,...t,o)})(o,t),t},g=(e,o,n,t)=>{if(((e,o,n)=>{const t=a(e),r=u(e);console.groupCollapsed(`${t} WARNING`,...r),console.warn("⚠️ Operation:",e),console.warn("📢 Message:",o),n&&console.warn("📋 Context:",n),console.warn("⏰ Timestamp:",s()),console.groupEnd()})("DEPRECATED_ONCHANGE","onChange callback is deprecated in phaser-hooks. Use .on('change', callback) or .once('change', callback) instead.",{key:o}),!t||"function"!=typeof t)throw new Error("[withStateDef] onChange callback must be a function");e.events.on(`changedata-${o}`,(e,o,r,l)=>{n&&c(o,l,r);try{t(r,l)}catch(e){((e,o,n)=>{const t=a(e),r=u(e);console.groupCollapsed(`${t} ERROR`,...r),console.error("🚨 Operation:",e),console.error("💥 Error:",o),n&&console.error("📋 Context:",n),console.error("⏰ Timestamp:",s()),console.groupEnd()})("ONCHANGE_CALLBACK_ERROR",e,{key:o})}})},f=(e,o,n,t,r)=>{if(!e.has(o)&&void 0!==r){if(t){const e=t(r);if(!0!==e){throw new Error(`[withStateDef] ${"string"==typeof e?e:`Invalid initial value for key "${o}"`}`)}}e.set(o,r),n&&((e,o)=>{const n=a("STATE_INIT"),t=u("STATE_INIT");console.groupCollapsed(`${n} Initializing state "${e}"`,...t),console.log("🔧 Key:",e),console.log("📦 Initial Value:",o),console.log("⏰ Timestamp:",s()),console.groupEnd()})(o,r)}},y=(e,o,n)=>{e.events.removeAllListeners(`changedata-${o}`),n&&(e=>{const o=a("CLEAR_LISTENERS"),n=u("CLEAR_LISTENERS");console.groupCollapsed(`${o} Clearing all listeners for "${e}"`,...n),console.log("🔑 Key:",e),console.log("🧹 Action:","Removing all event listeners"),console.log("⏰ Timestamp:",s()),console.groupEnd()})(o)},m=(e,o,t,r={})=>{((e,o,n)=>{if(!e)throw new Error("[withStateDef] Scene parameter is required");if(!n||"string"!=typeof n||0===n.trim().length)throw new Error("[withStateDef] Key must be a non-empty string");if(o.global&&!e.registry)throw new Error("[withStateDef] Scene registry is not available. Ensure the scene is properly initialized.");if(!o.global&&!e.data)throw new Error("[withStateDef] Scene data is not available. Ensure the scene is properly initialized.")})(e,r,o);const{validator:l,debug:i=!1,global:s=!1}=r,a=s?e.registry:e.data;return f(a,o,i,l,t),{get:()=>d(a,o,i),set:e=>((e,o,n,t,r)=>{const l=e.get(o),i="function"==typeof n?n(l):n;if(r){const e=r(i);if(!0!==e)throw new Error(`[withStateDef] ${"string"==typeof e?e:`Invalid value for key "${o}"`}`)}e.set(o,i),t&&c(o,l,i)})(a,o,e,i,l),patch:e=>((e,o,t,r,l)=>{const i=e.get(o);if("object"!=typeof i||null===i)throw new Error("[withStateDef] Current value is not an object");const s="function"==typeof t?t(i):t,a=n({},i,s);if(l){const e=l(a);if(!0!==e)throw new Error(`[withStateDef] ${"string"==typeof e?e:`Invalid value for key "${o}"`}`)}e.set(o,a),r&&c(o,i,a)})(a,o,e,i,l),onChange:e=>g(a,o,i,e),on:(e,n)=>((e,o,n,t,r)=>{if("change"!==o)throw new Error('[withStateDef] Invalid event. Only "change" is supported.');return t&&h(n,o,r),e.events.on(`changedata-${n}`,r),()=>{t&&p(n,o,r),e.events.off(`changedata-${n}`,r)}})(a,e,o,i,n),once:(e,n)=>((e,o,n,t,r)=>{if("change"!==o)throw new Error('[withStateDef] Invalid event. Only "change" is supported.');return t&&h(n,o,r),e.events.once(`changedata-${n}`,r),()=>{t&&p(n,o,r),e.events.off(`changedata-${n}`,r)}})(a,e,o,i,n),off:(e,n)=>((e,o,n,t,r)=>{if("change"!==o)throw new Error('[withStateDef] Invalid event. Only "change" is supported.');e.events.off(`changedata-${n}`,r),t&&p(n,o,r)})(a,e,o,i,n),clearListeners:()=>y(a,o,i)}},S=(e,o,n,t,r="local")=>{const l=`phaser-hooks-state:${o}`;let i=n;try{const e="local"===r?localStorage.getItem(l):sessionStorage.getItem(l);e&&(i=JSON.parse(e))}catch(e){console.warn(`[withPersistentState] Failed to load stored state for "${o}":`,e)}const s=((e,o,n,t)=>{if(!e)throw new Error("[withGlobalState] Scene parameter is required");return m(e,`phaser-hooks:global:${o}`,n,{...t,global:!0})})(e,o,i);return s.onChange(e=>{try{("local"===r?localStorage:sessionStorage).setItem(l,JSON.stringify(e))}catch(e){console.warn(`[withPersistentState] Failed to save state for "${o}":`,e)}}),s};var v="soundStudio",E=function(e){function o(o){var n=e.call(this,o)||this;return n.channelVolumes={},n.soundList={},n.soundLoader=new t(n),n.channels={},n.storage="local",n.soundPlayer=new r(n),n.soundRegistry=new l(n),n}return function(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function n(){this.constructor=e}i(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}(o,e),o.prototype.getGame=function(){return this.game},o.prototype.init=function(e){var o=this,n=e.soundList,t=e.channels,r=e.storage,l=e.gameName;this.soundList=n,this.channels=t,this.storage=r,this.gameName=l,Object.keys(t).forEach(function(e){o.channelVolumes[e]=1})},o.prototype.loadAll=function(e){for(var o=0,n=Object.entries(this.soundList).filter(function(e){return!1!==e[1].preload});o<n.length;o++){var t=n[o],r=t[0],l=t[1];e.load.audio(r,l.path)}this.loadChannelVolumes(e)},o.prototype.loadByChannel=function(e,o){this.soundLoader.loadByChannel(e,o),this.loadChannelVolumes(e)},o.prototype.loadBySoundKey=function(e,o){this.soundLoader.loadBySoundKey(e,o)},o.prototype.play=function(e){this.soundPlayer.play(e)},o.prototype.playOnce=function(e,o){var n=e.sound.get(o);(null==n?void 0:n.isPlaying)||this.play(o)},o.prototype.lazyLoadPlay=function(e,o){var n,t=this,r=null===(n=this.soundList[o])||void 0===n?void 0:n.path;r&&(e.load.audio(o,r),e.load.once("filecomplete-audio-".concat(o),function(){t.play(o)}))},o.prototype.setChannelVolume=function(e,o,n){(n<0||n>1)&&(n=Math.max(0,Math.min(1,n)),console.warn("Volume must be between 0 and 1. Setting volume to ".concat(n," instead in channel ").concat(o,"."))),this.channelVolumes[o]=n,Object.entries(this.soundList).filter(function(e){return e[1].channel===o}).forEach(function(o){var t=o[0],r=e.sound.get(t);r&&"setVolume"in r&&r.setVolume(n)}),this.saveChannelVolumes(e)},o.prototype.getChannelVolume=function(e){var o;return null!==(o=this.channelVolumes[e])&&void 0!==o?o:1},o.prototype.muteChannel=function(e,o){this.setChannelVolume(e,o,0)},o.prototype.unmuteChannel=function(e,o){this.setChannelVolume(e,o,1)},o.prototype.getAllChannels=function(){return this.channels},o.prototype.persistNameKey=function(){return this.gameName?"phaser-sound-studio-volumes:".concat(this.gameName):"phaser-sound-studio-volumes"},o.prototype.saveChannelVolumes=function(e){S(e,this.persistNameKey(),this.channelVolumes,0,this.storage).set(this.channelVolumes)},o.prototype.loadChannelVolumes=function(e){var o=S(e,this.persistNameKey(),this.channelVolumes,0,this.storage);this.channelVolumes=o.get()},o}(o.Plugins.BasePlugin);e.DEFAULT_MAX_INSTANCES=10,e.PHASER_SOUND_STUDIO_KEY=v,e.PhaserSoundStudioPlugin=E,e.SoundLoader=t,e.SoundPlayer=r,e.SoundRegistry=l,e.getSoundStudio=function(e,o){return void 0===o&&(o=v),e.plugins.get(o)}});
